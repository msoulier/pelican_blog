<!DOCTYPE html>
<html lang="en">
<head>
        <title>A working logger</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
                        <link href="http://feeds.feedburner.com/ButIDigress" type="application/rss+xml" rel="alternate" title="But I Digress RSS Feed" />
        
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
<a href="http://github.com/msoulier">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href=".">But I Digress </a></h1>
                <h2>Random neuron firings, digitized heedless of the
                repurcussions.</h2>
                <nav><ul>
                                                                    <li><a href="./pages/michael-p-souliers-curriculum-vitae.html">Michael P. Soulier's Curriculum Vitae</a></li>
                                                                    <li ><a href="./category/customer-service.html">Customer Service</a></li>
                                    <li class="active"><a href="./category/development.html">Development</a></li>
                                    <li ><a href="./category/driving.html">Driving</a></li>
                                    <li ><a href="./category/personal.html">Personal</a></li>
                                    <li ><a href="./category/quotes.html">Quotes</a></li>
                                    <li ><a href="./category/technology.html">Technology</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="a-working-logger.html" rel="bookmark"
           title="Permalink to A working logger">A working logger</a></h1>
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="msoulier">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2015-12-28T11:00:00">
                Mon 28 December 2015
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/michael-p-soulier.html">Michael P. Soulier</a>
        </address>
        <p>In <a href="./category/development.html">Development</a>. </p>
<p>tags: <a href="./tag/c.html">C++</a></p></footer><!-- /.post-info -->      <p>So it took some work, and likely there are better ways to do this, but this
logger satisfies my current needs in providing multiple levels of logging,
and an iostream interface to make composing strings simpler. First some
includes and definitions.</p>
<div class="highlight"><pre>#include &lt;stdio.h&gt;
#include &lt;ostream&gt;
#include &lt;boost/thread.hpp&gt;
#include &lt;boost/thread/mutex.hpp&gt;

#define LOGLEVEL_TRACE 0
#define LOGLEVEL_DEBUG 10
#define LOGLEVEL_INFO 20
#define LOGLEVEL_WARN 30
#define LOGLEVEL_ERROR 40
</pre></div>
<p>Then my thread-local buffer.</p>
<div class="highlight"><pre>extern boost::thread_specific_ptr&lt;std::stringstream&gt; tls_buffer;
</pre></div>
<p>The intention here is to &quot;collect&quot; logs from successive calls to the &lt;&lt; operator
in one line, using a thread-local buffer to prevent each thread from
stepping on one another. At the end of the line, we will then synchronize
around the write to the std::ostream and flush the buffer. There might be a
way to declare the tls_buffer inside of the class but my C++ chops are
currently insufficient.</p>
<p>I am also aware that one could use a temporary variable hack to get a
thread-local buffer without using boost here, but the examples that I found
showing this were very hard for me to understand. This, I understand so I'm
going with it for now.</p>
<p>Now, my logger is broken up into two classes. The main logger, and the
logger handlers that are used to do the actual logging at each level
(ie. debug, info, error, etc). This handler is where the &lt;&lt; operator
overloading magic happens.</p>
<div class="highlight"><pre>class MLoggerHandler
{
public:
    MLoggerHandler(boost::mutex&amp; mutex,
                std::ostream&amp; ostream,
                int threshold,
                std::string prefix);
    ~MLoggerHandler();
    void setLevel(int level);

    template &lt;class T&gt;
    // For handling &lt;&lt; from any object.
    MLoggerHandler&amp; operator &lt;&lt;(T input) {
        // Only log if the level is set above our threshold.
        if (m_threshold &gt;= m_level) {
            if (tls_buffer.get() == NULL) {
                tls_buffer.reset(new std::stringstream());
            }
            if (tls_buffer-&gt;str().length() == 0) {
                *tls_buffer &lt;&lt; localDateTime() &lt;&lt; &quot; &quot; &lt;&lt; m_prefix &lt;&lt; &quot;: &quot; &lt;&lt; input;
            }
            else {
                *tls_buffer &lt;&lt; input;
            }
        }
        return *this;
    }
    // For handling std::endl
    std::ostream&amp; operator &lt;&lt;(std::ostream&amp; (*f)(std::ostream&amp;)) {
        // Only log if the level is set above our threshold.
        if (m_threshold &gt;= m_level) {
            boost::lock_guard&lt;boost::mutex&gt; lock{m_mutex};
            // Flush the buffer
            m_ostream &lt;&lt; tls_buffer-&gt;str();
            f(m_ostream);
            // Clear the buffer
            tls_buffer-&gt;str(&quot;&quot;);
        }
        return m_ostream;
    }
private:
    // A mutex passed in from the main logger for synchronization.
    boost::mutex&amp; m_mutex;
    // The logging level.
    int m_level;
    // The output stream.
    std::ostream&amp; m_ostream;
    // The threshold for logging for this handler.
    int m_threshold;
    // The string prefix for logging.
    std::string m_prefix;
    // Return the current date and time as a localized string.
    const std::string localDateTime();
};
</pre></div>
<!-- ** -->
<p>Note that the &lt;&lt; overload takes any type capable of itself using the &lt;&lt;
operator, while there's a separate method required to implement handling
for the <cite>std::endl</cite> at the end of the line. This allows us to knwo when the
line is terminated, to write and flush the buffer, but it also imposes the
limitation that the user of this logger <em>must</em> provide the <cite>std::endl</cite> to
terminate the line or the logger won't work properly. These handlers are
returned as a result of calling the individual level methods in the main
logger, like <cite>info()</cite>, <cite>debug()</cite>, etc.</p>
<p>Also note that when the thread-local buffer is empty, that is used as an
indication of building the beginning of the line, and thus starting with
a logging level prefix and a timestamp.</p>
<p>And now the main logger...</p>
<div class="highlight"><pre>/*
* The MLogger (Mike-logger) is a thread-safe C++ logger using the iostream operators.
* To use it, you must invoke a logging level handler which will return an
* MLoggerHandler reference, and then terminate your line with std::endl to ensure
* that the buffer is flushed and the line terminated with a newline.
*/
class MLogger
{
public:
    MLogger();
    MLogger(std::string name);
    ~MLogger();
    // Set the current logging level
    void setLevel(int level);
    // Get the current logging level
    int getLevel();
    // Convenience methods for trace level log.
    MLoggerHandler&amp; trace();
    // Convenience methods for debug level log
    MLoggerHandler&amp; debug();
    // Convenience methods for info level log
    MLoggerHandler&amp; info();
    // Convenience methods for warning level log
    MLoggerHandler&amp; warn();
    // Convenicence methods for error level log
    MLoggerHandler&amp; error();
private:
    // The logger name.
    std::string m_name;
    // The current log level.
    int m_level;
    // The output stream for the logger.
    std::ostream&amp; m_ostream;
    // The mutex used for synchronization.
    boost::mutex m_mutex;
    // Trace handler
    MLoggerHandler m_trace_handler;
    // Debug handler
    MLoggerHandler m_debug_handler;
    // Info handler
    MLoggerHandler m_info_handler;
    // Warn handler
    MLoggerHandler m_warn_handler;
    // Error handler
    MLoggerHandler m_error_handler;
};
</pre></div>
<!-- ** -->
<p>The implementation is nothing special, but for completeness here it is.</p>
<div class="highlight"><pre>boost::thread_specific_ptr&lt;std::stringstream&gt; tls_buffer;

MLoggerHandler::MLoggerHandler(boost::mutex&amp; mutex,
                            std::ostream&amp; ostream,
                            int threshold,
                            std::string prefix)
    : m_mutex(mutex)
    , m_level(LOGLEVEL_INFO)
    , m_ostream(ostream)
    , m_threshold(threshold)
    , m_prefix(prefix)
{ }

MLoggerHandler::~MLoggerHandler() { }

void MLoggerHandler::setLevel(int level) {
    m_level = level;
}

const std::string MLoggerHandler::localDateTime() {
    const char *format = &quot;%b %d %Y @ %X %Z&quot;;
    std::time_t t = std::time(NULL);
    char buffer[128];
    if (std::strftime(buffer, sizeof(buffer), format, std::localtime(&amp;t))) {
        return std::string(buffer);
    }
    else {
        return &quot;&quot;;
    }
}

MLogger::MLogger(std::string name)
    : m_name(name)
    , m_level(LOGLEVEL_INFO)
    , m_ostream(std::cerr)
    , m_trace_handler(MLoggerHandler(m_mutex, m_ostream, LOGLEVEL_TRACE, &quot;TRACE&quot;))
    , m_debug_handler(MLoggerHandler(m_mutex, m_ostream, LOGLEVEL_DEBUG, &quot;DEBUG&quot;))
    , m_info_handler(MLoggerHandler(m_mutex, m_ostream, LOGLEVEL_INFO, &quot;INFO&quot;))
    , m_warn_handler(MLoggerHandler(m_mutex, m_ostream, LOGLEVEL_WARN, &quot;WARN&quot;))
    , m_error_handler(MLoggerHandler(m_mutex, m_ostream, LOGLEVEL_ERROR, &quot;ERROR&quot;))
    { }

MLogger::MLogger() : MLogger(&quot;No name&quot;) { }

MLogger::~MLogger() { }

int MLogger::getLevel() {
    return m_level;
}

void MLogger::setLevel(int level) {
    m_level = level;
    // And set it on all of the logger handlers.
    m_trace_handler.setLevel(level);
    m_debug_handler.setLevel(level);
    m_info_handler.setLevel(level);
    m_warn_handler.setLevel(level);
    m_error_handler.setLevel(level);
}

MLoggerHandler&amp; MLogger::trace() {
    return m_trace_handler;
}

MLoggerHandler&amp; MLogger::debug() {
    return m_debug_handler;
}

MLoggerHandler&amp; MLogger::info() {
    return m_info_handler;
}

MLoggerHandler&amp; MLogger::warn() {
    return m_warn_handler;
}

MLoggerHandler&amp; MLogger::error() {
    return m_error_handler;
}
</pre></div>
<!-- ** -->
<p>Currently, I'm using this through a simple shared global called <cite>logger</cite>,
so you then just use it like so:</p>
<div class="highlight"><pre>MLogger logger;

logger.setLevel(LOGLEVEL_INFO);

// This produces no output at INFO logging level.
logger.debug() &lt;&lt; &quot;The current value of foo is &quot; &lt;&lt; foo &lt;&lt; std::endl;

// This produces output.
logger.info() &lt;&lt; &quot;The current value of bar is &quot; &lt;&lt; bar &lt;&lt; std::endl;
</pre></div>
<p>So, it works, it's thread safe, and I don't have to manually build my own
logging strings with <cite>std::stringstream</cite>, saving endless lines of code. I'm
certain that it can be improved, I can certainly build in facilities like
log rotation, compression, etc. But, it's a start.</p>

    </div><!-- /.entry-content -->
        <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "a-working-logger.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://butidigressca.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
    
  </article>
</section>
        <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
                                                    <li><a href="http://python.org">Python.org</a></li>
                                                    <li><a href="http://life-unbalanced.tumblr.com/">Life, unbalanced</a></li>
                                                    <li><a href="http://excess.org">Ian Ward</a></li>
                                                    <li><a href="http://www.mahdiyusuf.com/">Mahdi Yusuf</a></li>
                                                    <li><a href="http://mikegrouchy.com/">Mike Grouchy</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                                                                                                                    <li><a href="http://feeds.feedburner.com/ButIDigress" type="application/rss+xml" rel="alternate">rss feed</a></li>
                                                            
                                                    <li><a href="http://twitter.com/msoulier">Twitter</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                <p>Email me at msoulier at digitaltorque dot ca</p>
                </address><!-- /#about -->

        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'butidigressca';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>