<!DOCTYPE html>
<html lang="en">
<head>
        <title>But I Digress - Python</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href=".././theme/css/main.css" type="text/css" />
        
        
        <link href="http://feeds.feedburner.com/ButIDigress" type="application/rss+xml" rel="alternate" title="But I Digress RSS Feed" />
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie.css"/>
                <script src=".././js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

<a href="http://github.com/msoulier">

<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />

</a>

        <header id="banner" class="body">
                <h1><a href="../.">But I Digress </a></h1>
                <h2>Random neuron firings, digitized heedless of the
                repurcussions.</h2>
                <nav><ul>
                
                
                
                    <li><a href=".././pages/resume.html">Resum√©</a></li>
                
                
                
                    <li ><a href=".././category/development.html">Development</a></li>
                
                    <li ><a href=".././category/personal.html">Personal</a></li>
                
                    <li ><a href=".././category/technology.html">Technology</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
                

            

        
        
            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href=".././suspend-on-lid-close-debian-squeeze.html">Suspend on lid close in Debian Squeeze</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2012-11-20T22:10:00">
                Tue 20 November 2012
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/michael-p-soulier.html">Michael P. Soulier</a>
        </address>
        
<p>In <a href=".././category/technology.html">Technology</a>. </p>
<p>tags: <a href=".././tag/linux.html">Linux</a><a href=".././tag/open-source.html">Open Source</a><a href=".././tag/python.html">Python</a></p>


</footer><!-- /.post-info --><p>I recently decided that <a class="reference external" href="http://www.gnome.org">Gnome</a> is not the best desktop for my little <a class="reference external" href="http://www.asus.com/Eee/">EeePC</a>
netbook with a little 10.5&quot; screen. So I'm playing around with a window
manager that mainly just maximizes everything. I've tried <a class="reference external" href="http://www.nongnu.org/ratpoison/">Ratpoison</a>, I've
tried <a class="reference external" href="https://code.google.com/p/wmii/">wmii</a>, and now I'm trying <a class="reference external" href="http://awesome.naquadah.org/">Awesome</a>.</p>
<p>I have a lot of customizations to do, but one thing that was missing was a way
to suspend the netbook when the laptop lid is closed. I could manually run
<tt class="docutils literal">acpitool <span class="pre">-s</span></tt> in a shell, or <tt class="docutils literal"><span class="pre">pm-suspend</span></tt>, but it's best handled by DBus, as
intended.</p>
<p>Now, a simple way to have DBus do the work is using <tt class="docutils literal"><span class="pre">dbus-send</span></tt>, like so:</p>
<pre class="literal-block">
dbus-send --print-reply \
          --system \
          --dest=org.freedesktop.UPower \
          /org/freedesktop/UPower \
          org.freedesktop.UPower.Suspend
</pre>
<p>The hard part is subscribing to the lid close event, so I'm not polling all
the time, exactly what DBus was written to prevent. I had a Python script for
this, but the API was changed in Squeeze to use the <a class="reference external" href="http://upower.freedesktop.org/">UPower</a> daemon and API.</p>
<p>I had to do some poking around to figure out how to update it, but I just got
it working, so I thought I'd share.</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">dbus</span><span class="o">,</span> <span class="nn">gobject</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">dbus.mainloop.glib</span> <span class="kn">import</span> <span class="n">DBusGMainLoop</span>

<span class="n">pow_prop_iface</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">pow_iface</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">handle_lidclose</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">closed</span> <span class="o">=</span> <span class="n">pow_prop_iface</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                                <span class="s">&#39;LidIsClosed&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;lid is closed, suspending&quot;</span>
        <span class="n">pow_iface</span><span class="o">.</span><span class="n">Suspend</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;lid is open&quot;</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">pow_prop_iface</span><span class="p">,</span> <span class="n">pow_iface</span>

    <span class="n">DBusGMainLoop</span><span class="p">(</span><span class="n">set_as_default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">bus</span> <span class="o">=</span> <span class="n">dbus</span><span class="o">.</span><span class="n">SystemBus</span><span class="p">()</span>

    <span class="n">power_proxy</span> <span class="o">=</span> <span class="n">bus</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="s">&#39;org.freedesktop.UPower&#39;</span><span class="p">,</span>
                                <span class="s">&#39;/org/freedesktop/UPower&#39;</span><span class="p">)</span>

    <span class="n">pow_prop_iface</span> <span class="o">=</span> <span class="n">dbus</span><span class="o">.</span><span class="n">Interface</span><span class="p">(</span><span class="n">power_proxy</span><span class="p">,</span>
                                    <span class="s">&#39;org.freedesktop.DBus.Properties&#39;</span><span class="p">)</span>
    <span class="n">pow_iface</span> <span class="o">=</span> <span class="n">dbus</span><span class="o">.</span><span class="n">Interface</span><span class="p">(</span><span class="n">power_proxy</span><span class="p">,</span>
                               <span class="s">&#39;org.freedesktop.UPower&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&quot;Registering a signal receiver for upower events...&quot;</span>

    <span class="n">bus</span><span class="o">.</span><span class="n">add_signal_receiver</span><span class="p">(</span><span class="n">handle_lidclose</span><span class="p">,</span>
                            <span class="n">dbus_interface</span><span class="o">=</span><span class="s">&quot;org.freedesktop.UPower&quot;</span><span class="p">,</span>
                            <span class="n">signal_name</span><span class="o">=</span><span class="s">&quot;Changed&quot;</span><span class="p">)</span>


    <span class="n">loop</span> <span class="o">=</span> <span class="n">gobject</span><span class="o">.</span><span class="n">MainLoop</span><span class="p">()</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<p>Now I just run it in the background from my <cite>.xsession</cite> script at X11 login,
and it's sitting there waiting for any change in UPower status. Works like a
charm.</p>

                </article>
                
            </aside><!-- /#featured -->
            
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
            
        
        
        
            

        
         
            
            <li><article class="hentry">    
                <header>
                    <h1><a href=".././new-static-blog.html" rel="bookmark"
                           title="Permalink to New blog">New blog</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2012-11-03T10:20:00">
                Sat 03 November 2012
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/michael-p-soulier.html">Michael P. Soulier</a>
        </address>
        
<p>In <a href=".././category/personal.html">Personal</a>. </p>
<p>tags: <a href=".././tag/blogging.html">Blogging</a><a href=".././tag/python.html">Python</a></p>


</footer><!-- /.post-info -->
                <p>So I decided to dump Wordpress and go to something that I have more control
over. I was thinking of building my own static blogging system, but I looked
around and found that there are a few already. Being a fan of <a class="reference external" href="http://www.python.org/">Python</a> I
decided to try out <a class="reference external" href="http://docs.getpelican.com/en/3.0/">Pelican</a>. It ...</p>
                <a class="readmore" href=".././new-static-blog.html">read more</a>
                
                </div><!-- /.entry-content -->
            </article></li>
        
        
            </ol><!-- /#posts-list -->
            
                
<p class="paginator">
    
    Page 1 / 1
    
</p>

            
            </section><!-- /#content -->
        
    


        <section id="extras" class="body">
        
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                        
                            <li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
                        
                            <li><a href="http://python.org">Python.org</a></li>
                        
                            <li><a href="http://jinja.pocoo.org">Jinja2</a></li>
                        
                            <li><a href="http://fit613.wordpress.com">Fit613</a></li>
                        
                            <li><a href="http://excess.org">Ian Ward's blog</a></li>
                        
                            <li><a href="http://www.mahdiyusuf.com/">Mahdi Yusuf</a></li>
                        
                            <li><a href="http://mikegrouchy.com/">Mike Grouchy</a></li>
                        
                        </ul>
                </div><!-- /.blogroll -->
        
        
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            
                            
                                
                            <li><a href="http://feeds.feedburner.com/ButIDigress" type="application/rss+xml" rel="alternate">rss feed</a></li>
                                
                            

                        
                            <li><a href="http://twitter.com/msoulier">Twitter</a></li>
                        
                        </ul>
                </div><!-- /.social -->
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                <p>Email me at msoulier at digitaltorque dot ca</p>
                </address><!-- /#about -->

        </footer><!-- /#contentinfo -->




</body>
</html>