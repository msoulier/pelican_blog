<!DOCTYPE html>
<html lang="en">
<head>
        <title>But I Digress - Web Services</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
        <link href="http://feeds.feedburner.com/ButIDigress" type="application/rss+xml" rel="alternate" title="But I Digress RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
<a href="http://github.com/msoulier">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="..">But I Digress </a></h1>
                <h2>Random neuron firings, digitized heedless of the
                repurcussions.</h2>
                <nav><ul>
                    <li><a href="../pages/mike-souliers-curriculum-vitae.html">Mike Soulier's Curriculum Vitae</a></li>
                    <li ><a href="../category/customer-service.html">Customer Service</a></li>
                    <li ><a href="../category/development.html">Development</a></li>
                    <li ><a href="../category/driving.html">Driving</a></li>
                    <li ><a href="../category/personal.html">Personal</a></li>
                    <li ><a href="../category/quotes.html">Quotes</a></li>
                    <li ><a href="../category/technology.html">Technology</a></li>
                </ul></nav>
        </header><!-- /#banner -->
        
        

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../signatures-in-oauth.html">Signatures in OAuth</a></h1> 
<footer class="post-info">
        <abbr class="published" title="2012-12-21T18:00:00-05:00">
                Fri 21 December 2012
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="../author/michael-p-soulier.html">Michael P. Soulier</a>
        </address>
<p>In <a href="../category/technology.html">Technology</a>. </p>
<p>tags: <a href="../tag/oauth.html">OAuth</a><a href="../tag/web-services.html">Web Services</a><a href="../tag/python.html">Python</a><a href="../tag/perl.html">Perl</a></p></footer><!-- /.post-info --><p>Hi again. I already went into the basics of OAuth in a <a class="reference external" href="http://www.but-i-digress.ca/understanding-oauth.html">previous post</a>, and
alluded to the signatures being the hard part of the implementation. I'm using
a <a class="reference external" href="https://github.com/leah/python-oauth/">python-oauth</a> module for the client, but for the server, I decided to
implement my own in <a class="reference external" href="http://www.perl.org/">Perl</a> and <a class="reference external" href="http://mojolicio.us/">Mojolicious</a>, since I had problems with
<a class="reference external" href="http://search.cpan.org/dist/Net-OAuth/lib/Net/OAuth.pm">Net::OAuth</a> that I deemed a protocol violation. Besides, I learn more this
way.</p>
<p>There are multiple signature methods supported in OAuth 1.0, specifically
three.</p>
<blockquote>
<ol class="arabic simple">
<li>PLAINTEXT</li>
<li>HMAC-SHA1</li>
<li>RSA-SHA1</li>
</ol>
</blockquote>
<p>Unsurprisingly, <tt class="docutils literal">PLAINTEXT</tt> is the simplest. In this case, the signature is
a simple combination of the consumer secret and the token secret, if there is
any yet, with a slight twist. To ensure that the characters are treated
properly, they must first be &quot;normalized&quot;. This means decoding them as you
would any percent-encoded string, and then...</p>
<blockquote>
<ul>
<li><p class="first">convert them to UTF-8</p>
</li>
<li><p class="first">escape them with percent-encoding from RFC 3986 like so</p>
<blockquote>
<ul class="simple">
<li>these characters are not encoded: alphanumerics, &quot;-&quot;, &quot;.&quot;, &quot;_&quot;, &quot;~&quot;</li>
<li>all other characters <em>must</em> be encoded</li>
<li>any hexidecimal used in encoding must be upper-case</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<p>I found that hard to read, but I did find this bit of Perl to solve the
problem in <tt class="docutils literal"><span class="pre">Net::OAuth</span></tt>, which I converted to a Mojolicious helper.</p>
<div class="highlight"><pre><span class="n">helper</span> <span class="n">encode</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$str</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="nv">$str</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="k">unless</span> <span class="nb">defined</span> <span class="nv">$str</span><span class="p">;</span>
    <span class="k">unless</span><span class="p">(</span><span class="nv">$SKIP_UTF8_DOUBLE_ENCODE_CHECK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$str</span> <span class="o">=~</span><span class="sr"> /[\x80-\xFF]/</span> <span class="ow">and</span> <span class="o">!</span><span class="nn">utf8::</span><span class="n">is_utf8</span><span class="p">(</span><span class="nv">$str</span><span class="p">))</span> <span class="p">{</span>
            <span class="nb">warn</span><span class="p">(</span><span class="s">&quot;your OAuth message appears to contain some &quot;</span>
                <span class="o">.</span> <span class="s">&quot;multi-byte characters that need to be decoded &quot;</span>
                <span class="o">.</span> <span class="s">&quot;via Encode.pm or a PerlIO layer first. &quot;</span>
                <span class="o">.</span> <span class="s">&quot;This may result in an incorrect signature.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span>
    <span class="nn">URI::Escape::</span><span class="n">uri_escape_utf8</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span><span class="s">&#39;^\w.~-&#39;</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
<p>Decoding is even simpler.</p>
<div class="highlight"><pre><span class="n">helper</span> <span class="n">decode</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$str</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">uri_unescape</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
<p>In Python, the same code looks like so.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">urllib</span>

<span class="k">def</span> <span class="nf">escape</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Escape a URL including any /.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s">&#39;~&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_utf8_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert unicode to utf-8.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="n">escaped</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="n">_utf8_str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

<span class="c"># Unquoting is just</span>
<span class="n">unquoted</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
<p>So, this needs to be done to each of the parameters, in this case, the
consumer key and the token secret, if any, and then they are combined with an
ampersand. So, if your consumer key is, say, &quot;myconsumerkey&quot;, and you don't
have a token yet, then the initial <tt class="docutils literal">PLAINTEXT</tt> signature is
<tt class="docutils literal">myconsumerkey&amp;</tt>.</p>
<p>Now, this isn't too bad, but once you get into <tt class="docutils literal"><span class="pre">HMAC-SHA1</span></tt> signatures, it
gets a lot worse. The signature from the <tt class="docutils literal">PLAINTEXT</tt> method becomes the key
for the signature, and you'll already have the code for that now, but the raw
input to the <tt class="docutils literal"><span class="pre">HMAC-SHA1</span></tt> algorithm is a base string, that is rather
difficult to construct. The input is the HTTP method, the request URI, both
normalized like above and contatenated with an ampersand. Then, this will be
contatenated with an ampersand to all of the input parameters in the request,
constructed in a particular way.</p>
<blockquote>
<ol class="arabic simple">
<li>Take all input parameter names and values from all sources, and normalize them like above. (but skip the oauth_signature parameter)</li>
<li>Sort all parameters by the normalized parameter name.</li>
<li>Pair the names and values, contatenated with an &quot;=&quot;.</li>
<li>Concatenate all pairs with ampersands in the sorted order.</li>
<li>Escape the entire string using the method above.</li>
</ol>
</blockquote>
<p>This is the base string to the <tt class="docutils literal"><span class="pre">HMAC-SHA1</span></tt> algorithm, along with the key we
mentioned. The final signature should match what the client generated. Oh, and
if you're running your service on a nonstandard port (80 or 443), then you
<em>must</em> include the port in the URI.</p>
<p>Example:</p>
<p>A call to <a class="reference external" href="http://localhost/initiate">http://localhost/initiate</a> on port 80 or 443, a GET request, with the
following params:</p>
<pre class="literal-block">
{'oauth_nonce': '21823552', 'oauth_timestamp': 1356129798,
 'oauth_consumer_key': 'Mitel test', 'oauth_signature_method': 'HMAC-SHA1',
 'oauth_version': '1.0', 'oauth_signature': 'pevzNqSnJ8QtqFUDWVlYhVRp8D0=',
 'oauth_callback': 'oob'}
</pre>
<p>The base string would look like this:</p>
<pre class="literal-block">
GET&amp;http%3A%2F%2Flocalhost%2Finitiate&amp;oauth_callback%3Doob%26oauth_consumer_key%3DMitel%2520test%26oauth_nonce%3D21823552%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1356129798%26oauth_version%3D1.0
</pre>
<p>with a key of:</p>
<pre class="literal-block">
mitelsharedsecret&amp;
</pre>
<p>and a final signature of:</p>
<pre class="literal-block">
pevzNqSnJ8QtqFUDWVlYhVRp8D0=
</pre>
<p>Oddly, if I used the <tt class="docutils literal">b64encode</tt> method in <tt class="docutils literal"><span class="pre">Digest::HMAC_SHA1</span></tt>, a final
&quot;=&quot; sign is missing on the final result, so I had to pull in <tt class="docutils literal"><span class="pre">MIME::Base64</span></tt>
and do this instead:</p>
<div class="highlight"><pre><span class="k">my</span> <span class="nv">$sig</span> <span class="o">=</span> <span class="n">encode_base64</span><span class="p">(</span><span class="nv">$hmac</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">);</span>
</pre></div>
<p>The equivalent Python in the <tt class="docutils literal">oauth</tt> library does this:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">binascii</span>

<span class="c"># HMAC object.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">hashlib</span> <span class="c"># 2.5</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sha</span> <span class="c"># Deprecated</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">sha</span><span class="p">)</span>

<span class="c"># Calculate the digest base 64.</span>
<span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_base64</span><span class="p">(</span><span class="n">hashed</span><span class="o">.</span><span class="n">digest</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
<p>That just leaves <tt class="docutils literal"><span class="pre">RSA-SHA1</span></tt>, but that requires a pre-existing SSL
relationship with the server, using SSL certificates. As such, I'm not worrying
about it just yet. I don't think it'll be used much.</p>
<p>I'll need to do some interop testing with a few different clients, I'm hoping that
they're not all snowflakes. The point of the rigid nature of the base string
construction is that the final product is supposed to be reproducable.</p>
<p>The base string construction is definitely the hardest part, and I've read
that the signatures were dropped in OAuth 2.0 because they were too hard to
do. I'd rather not drop the added security, and while they're a pain, there
are sample implementations to follow. I think that OAuth 1.0 is a better
choice. And it's, like, finished.</p>
<p>There are <a href="../signatures-in-oauth.html#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
        

 
            <li><article class="hentry">    
                <header>
                    <h1><a href="../understanding-oauth.html" rel="bookmark"
                           title="Permalink to Understanding OAuth">Understanding OAuth</a></h1>
                </header>
                
                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2012-12-20T10:30:00-05:00">
                Thu 20 December 2012
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="../author/michael-p-soulier.html">Michael P. Soulier</a>
        </address>
<p>In <a href="../category/technology.html">Technology</a>. </p>
<p>tags: <a href="../tag/oauth.html">OAuth</a><a href="../tag/web-services.html">Web Services</a></p></footer><!-- /.post-info -->                <p>We meet again. Thanks for stopping by. This post has a high geek factor, so if
you're not one, feel free to move along, nothing to see here.</p>
<p>Still here? K, your funeral. At work, I'm trying to add a <a class="reference external" href="http://en.wikipedia.org/wiki/Representational_state_transfer">ReST</a> Web Service to
a product that could ...</p>
                <a class="readmore" href="../understanding-oauth.html">read more</a>
<p>There are <a href="../understanding-oauth.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
            </ol><!-- /#posts-list -->
<p class="paginator">
    Page 1 / 1
</p>
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
                            <li><a href="http://python.org">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org">Jinja2</a></li>
                            <li><a href="http://fit613.wordpress.com">Fit613</a></li>
                            <li><a href="http://excess.org">Ian Ward</a></li>
                            <li><a href="http://www.mahdiyusuf.com/">Mahdi Yusuf</a></li>
                            <li><a href="http://mikegrouchy.com/">Mike Grouchy</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://feeds.feedburner.com/ButIDigress" type="application/rss+xml" rel="alternate">rss feed</a></li>

                            <li><a href="http://twitter.com/msoulier">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                <p>Email me at msoulier at digitaltorque dot ca</p>
                </address><!-- /#about -->

        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'butidigressca';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>